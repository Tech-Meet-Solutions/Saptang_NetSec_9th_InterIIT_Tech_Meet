# PS
- Bug Overview: Specially crafted requests lead to DoS/RCE without any user interaction on Windows RDP service.
- Aim: Setup a local Vm in which to install vulnerable windows RDP service and write an exploit that could lead to DoS/RCE on the local VM server.
- Write a brief report about this bug including your exploit code and link for exploit and Video proof.

## Bug Overview

For Windows RDP service based on UDP, the application(service) has to handle the incoming packets and re-assemble them in the correct order as well as ensure that no parts are missing.

This information is obtained from the packet headers which have the following fields:
- `fragment id` : Denotes the fragment's position in the sequence
- `num_fragments` : Denotes the total number of fragment in the sequence
- `fragment_length` : Denotes the length of the fragment's data

The implementation of the packet handler in the Windows RDP service introduces some bugs. The below mentioned code snippets are parts of this handler function being used to demonstrate the bugs.

1.  ### CVE-2020-0609
    ``` c++
        if ((this->bytes_written + packet->fragment_len) > this->buffer_size)
            return error;

        /*
            some more code
        */

        memcpy_s(&this->buffer[1000 * packet->fragment_id], 1000, &packet->fragment, packet->fragment_len);

        this->bytes_written += packet->fragment_len;
    ```

    The first line of the above code snippet is a **bounds check** on the (re-assembly) buffer. `memcpy_s` copies each fragment to an offset in the buffer which is calculated using the `fragment_id `, while the third line notes the update of the `bytes_written` variable being used in the bounds check.

    Noting that the offset is not being used in the bounds check, we realize that this is a simple buffer overflow in which we control both the offset and the length of the data being written.

2.  ### CVE-2020-0610
    ``` c++
        if (this->frag_received[fragment_id]) 
            return ok;

        /*
            some more code
        */

        this->frag_received[fragment_id] = TRUE;
    ```

    This code snippet shows that whenever any packet is verified, it's marked as received so as to not worry about the same packet being received multiple times. The array `this->frag_received` has space for only upto 64 entries, but the `fragment_id` can be any number between 0 to 65535; and hence, this also is a buffer overflow, however with each received fragment just 1 bit is being modified.

## Environment

    A local VM running Windows Server 2019 (unpatched version) has been set up, and UDP mode of Remote Desktop Gateway has been enabled on the same. No additional configurations needs to be set up.

    Our code to exploit the vulnerability is as follows:
    # insert exploit code latest

## Report

    